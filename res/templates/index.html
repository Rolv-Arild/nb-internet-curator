{% extends "base.html" %}
{% block body %}
<div class="container" id="container">
    <div>
        <h2 class="display-2">{{ _('Pywb Wayback Machine') }}</h2>
    </div>
    <label id="file-button" for="filepicker" class="btn btn-primary">Choose archive folder</label>
    <input type="file"
           id="filepicker"
           class="btn btn-primary"
           style="opacity: 0;"
           name="fileList"
           webkitdirectory
           multiple/>
    <p class="lead">This archive contains the following collections:</p>
    <h2 style="padding-top: 50px;">
        Collections:
    </h2>
    <ul class="list-group">
        {% for route in routes %}
        <li class="list-group">
            <a class="list-group-item list-group-item-action" href="{{ env['pywb.app_prefix'] + '/' + route }}">{{ '/' +
                route }}</a>
            {% if all_metadata and all_metadata[route] %}
            ({{ all_metadata[route].title }})
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>
<script>
    default_url = "http://localhost:6969"

    function post(endpoint, body) {
        return fetch(default_url + "/" + endpoint, {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            credentials: 'same-origin',
            headers: {
                "Content-Type": "application/json",
                "Origin": "http://localhost/8080"
            },
            referrerPolicy: 'no-referrer',
            body: JSON.stringify(body)
        })
    }

    const container = document.getElementById("container");
    const fileButton = document.getElementById("file-button");

    function spawnAlert(msg, alertClass) {
        const div = document.createElement("div");
        if (alertClass === "warning") {
            div.classList.add("alert", "alert-warning")
            div.innerText = "Got error: " + msg;
        } else if (alertClass === "info") {
            div.classList.add("alert", "alert-info")
            div.innerText = msg
        }
        container.insertBefore(div, fileButton);
        setTimeout(() => {
            container.removeChild(div);
        }, 10000);
    }

    const filepicker = document.getElementById("filepicker");

    if (filepicker) {
        filepicker.addEventListener("change", function (event) {
            if (!event.target.files) {
                return;
            }
            let files = event.target.files;
            const folder = files[0].webkitRelativePath.split("/")[0];
            spawnAlert("Creating collection...", "info");
            post("add_collection", {folder}).then(resp => {
                if (resp.status >= 300) {
                    resp.text().then(s => spawnAlert(s, "warning"))
                } else {
                    location.reload();
                }
            }).catch(e => spawnAlert(e, "warning"))
        }, false);
    }
</script>
{% endblock %}
